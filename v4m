#!/bin/bash
# v4m - VM Manager for macOS (Modular Version)
# Usage: v4m <command> [options]

set -e

# Get script directory for relative imports
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load all modules
source "$SCRIPT_DIR/lib/core.sh"
source "$SCRIPT_DIR/lib/network.sh"
source "$SCRIPT_DIR/lib/setup.sh"
source "$SCRIPT_DIR/lib/images.sh"
source "$SCRIPT_DIR/lib/cloud-init.sh"
source "$SCRIPT_DIR/lib/vm.sh"

# Load configuration and set up cleanup
load_config
trap cleanup EXIT INT TERM

main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    case "$1" in
        "v4m_init")
            shift; v4m_init "$@"
            ;;
        "init")
            socket_vmnet_init
            ;;
        "vm")
            shift
            case "$1" in
                "create") shift; vm_create "$@" ;;
                "list") vm_list ;;
                "start") shift; vm_start "$@" ;;
                "stop") shift; vm_stop "$@" ;;
                "delete") shift; vm_delete "$@" ;;
                "ip") shift; vm_ip "$@" ;;
                "console") shift; vm_console "$@" ;;
                *) log_error "Unknown vm command: $1"; show_help; exit 1 ;;
            esac
            ;;
        "image")
            shift
            case "$1" in
                "list") image_list ;;
                "pull") shift; image_pull "$@" ;;
                "delete") shift; image_delete "$@" ;;
                *) log_error "Unknown image command: $1"; show_help; exit 1 ;;
            esac
            ;;
        "purge")
            purge
            ;;
        "-h"|"--help"|"help")
            show_help
            ;;
        *)
            log_error "Unknown command: $1"
            show_help
            exit 1
            ;;
    esac
}

main "$@"